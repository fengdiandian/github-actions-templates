name: Universal CI/CD Pipeline
 
on:
  workflow_call:
    inputs:
      ref:
        required: true 
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true 
      DOCKER_PASSWORD:
        required: true
      KUBECONFIG_BASE64:
        required: true
 
jobs:
  pipeline:
    runs-on: ubuntu-latest 
    steps:
      # ğŸ‘‡ 1. è·å–ä»£ç ï¼ˆæ ¹æ® refï¼‰
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref  }}
 
      # ğŸ‘‡ 2. è‡ªåŠ¨è¯†åˆ«è¯­è¨€ï¼ˆç®€åŒ–ç‰ˆï¼‰
      - name: Detect Language
        id: detect_lang
        run: |
          if [ -f "pom.xml"  ]; then
            echo "language=java" >> $GITHUB_OUTPUT 
          elif [ -f "package.json"  ]; then
            echo "language=nodejs" >> $GITHUB_OUTPUT
          else
            echo "Unsupported project type"
            exit 1
          fi
 
      # ğŸ‘‡ 3. ç¼–è¯‘ & æ‰“åŒ…ï¼ˆJava ç¤ºä¾‹ï¼‰
      - name: Setup Java 
        if: steps.detect_lang.outputs.language  == 'java'
        uses: actions/setup-java@v4 
        with:
          distribution: temurin
          java-version: 17
          cache: maven 
 
      - name: Build Project (Java)
        if: steps.detect_lang.outputs.language  == 'java'
        run: mvn clean package -DskipTests
 
      # ğŸ‘‡ 4. æ„å»º Docker é•œåƒï¼ˆtag/branch å†³å®šç‰ˆæœ¬ï¼‰
      - name: Set Image Version
        id: version
        run: |
          REF="${{ inputs.ref  }}"
          if [[ "$REF" == "refs/heads/main" ]]; then
            VERSION="latest"
          elif [[ "$REF" =~ ^refs/tags/v[0-9]+ ]]; then
            VERSION=$(echo "$REF" | sed 's|refs/tags/||')
          else
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
 
      - name: Login to Docker Registry
        run: |
          cat .github/workflows/configs/docker-registry.txt  | xargs -I {} echo "{}" > registry_url.txt 
          REGISTRY=$(cat registry_url.txt) 
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin "$REGISTRY"
 
      - name: Build and Push Docker Image 
        run: |
          REGISTRY=$(cat registry_url.txt) 
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          IMAGE_TAG="$REGISTRY/$REPO_NAME:${{ steps.version.outputs.version  }}"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
 
      # ğŸ‘‡ 5. ç”Ÿäº§ç¯å¢ƒå®¡æ‰¹ï¼ˆä»… main / release åˆ†æ”¯ï¼‰
      - name: Approve for Production Deployment 
        if: contains(inputs.ref,  'main') || contains(inputs.ref,  'release/')
        uses: trstringer/manual-approval@v1
        timeout-minutes: 60
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: team_lead,dev_ops_engineer
 
      # ğŸ‘‡ 6. æ›´æ–° Kubernetes éƒ¨ç½²
      - name: Deploy to K8s
        if: success()
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 --decode > ~/.kube/config 
          kubectl set image deployment/myapp *=${IMAGE_TAG}
 
      # ğŸ‘‡ 7. å‘é€éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Notify via Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com 
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          to: dev@example.com 
          subject: '[Deployment] ${{ github.repository  }} completed'
          body: |
            Successfully deployed ${{ github.repository  }} at version ${{ steps.version.outputs.version  }}
